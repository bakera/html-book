# URL

ウェブは3つの技術に支えられています。その3つとはHTML、URL、HTTPです。本書ではHTMLを扱いますが、HTMLは他の技術とも密接に関連しています。ここでは、URLの概要を紹介します。

## URLとは

URLは、リソースの場所を特定するための汎用的な識別子です。ネットワーク上の他のコンピュータ上のリソースも指すことができ、ハイパーリンクのリンク先を示すのに使われます。URLの仕様は、現在ではWHATWGのURL Standard[^1]で定義されています。

[^1]: https://url.spec.whatwg.org/

以下は、仕様で定義されるURLの例です。

```text
https://example.com/
https://example.com:443/foo/bar.php?q=xxx#result
mailto:info@example.com
file:////accesskey.html
```

このように、URLには様々な種類のものがあり、種類に応じて書式も異なります。

## URLの書式

ここでは、ウェブで最もよく利用される`https`のURLについて、その書式を紹介します。`https`URLの構成要素は、スキーム、ホスト、ポート、パス、クエリ、フラグメントの6つに分けることができます。

図: URLの構成要素
```
https://example.com:60000/foo/bar.php?q=xxx#result
スキーム ホスト       ポート パス       クエリ フラグメント
```

### スキーム

先頭の`https`とある箇所は「URLスキーム」(URL Scheme)と呼ばれます。スキームはURLの種類や性質そのものを表しており、スキームが異なるとURLの書式も異なります。

URLスキームはIANAに登録されており、Uniform Resource Identifier (URI) Schemes[^1]で確認することができます。

[^1]: https://www.iana.org/assignments/uri-schemes/uri-schemes.xhtml

従来、ウェブで最もよく利用されていたのは`http`スキームでした。これはHTTPで通信を行ったリソースを取得するスキームで、ウェブページそのものの場所を指すのに利用するほか、ウェブコンテンツで利用する画像など各種のサブリソースを参照する際にも利用します。

現在では、`https`スキームがよく利用されています[^2]。これは`http`と似ていますが、HTTP通信の際、「TLS」(Transport Layer Security)[^3]で保護された通信経路を用いることで、通信相手のなりすましや通信の傍受、改竄を防ぐ仕組みになっています。

[^2]: RFC 7230で定義さています。 <https://www.rfc-editor.org/rfc/rfc7230#section-2.7.2>
[^3]: 2021年10月現在、最もよく利用されるのはTLS 1.2で、RFC 5246で定義されています。RFC 8446で定義されるTLS 1.3も用いられています。

### ホスト、ポート

スキームの後は、1文字の`:`で区切ります[^3]。その後に続く内容はスキームによって異なりますが、`https`の場合には「ホスト」(host)が書かれます。ホストは、ドメイン名かIPアドレスのいずれかで、ほとんどの場合ドメイン名が使用されます。

[^3]: `:`の前までをスキームと呼ぶこともあれば、スキームであることを明確にするために、`:`まで含めて記述することもあります。本書では、URL Standardに従って、`:`を含めないものをスキームと呼びます。

ホストの後ろには「ポート」(port)の情報が来ることがあります。ポートは省略でき、`https`の場合デフォルトは443となります。以下の2つのURLは同じリソースを指します。

```text
https://example.com/
https://example.com:443/
```

### パス

ホストの後ろ (ポートが記述されている場合はポートの後ろ) には、「パス」(path)の記述が続きます。パスは、そのホスト内でリソースを特定するための記述です。

パスは`/`で始まり、さらに複数の`/`で区切って階層化することもできます。たとえば以下のようになります。

```text
https://example.net/foo/bar/baz.html
```

### クエリ

パスの後ろには、「クエリ」(query) と呼ばれる文字列がつくことがあります。クエリをつける場合は、`?`の1文字で区切ります。

クエリとは、「問い合わせ」というような意味です。GETメソッドと呼ばれる方式のフォームを送信すると、フォームに入力したデータがURLの末尾につけられ、URLを通じてサーバに送信されます。これがクエリで、サーバに対する問い合わせに使うことからこの名前が来ています。

クエリはフォーム送信の時だけでなく、アクセス元をトラッキングしたり、キャッシュを更新させる目的で使われることもあります。

### フラグメント

URLの末尾には、「フラグメント」(fragment)と呼ばれる文字列がつくことがあります。フラグメントをつける場合は、`#`一文字で区切ります。

フラグメントとは、「断片」という意味です。URLは特定のリソースを指しますが、そのリソース中の一部分を指したい時にフラグメントを使用します。HTMLの場合は、`id`属性で指定された名前をフラグメントとして指定することで、HTML文書の特定の箇所を指すことができます。

フラグメントは「ハッシュ」(hash)と呼ばれることもあります。これは、区切りに使用する文字`#` (U+0023, "NUMBER SIGN") が、別名でハッシュとも呼ばれるためです。たとえば、JavaScriptでは`location.hash`でフラグメントの値を参照することができます。

## ドメイン、サイト、オリジン

主にセキュリティ上の理由から、ふたつのリソースが同一サイトに属するかどうか判断したい場合があります。これはURLを見ることで判断できます。

URLのホスト部が一致している場合、「同一ドメイン」(same domain)であると言います。ホストはIPアドレスで記述することもできますが、多くの場合はドメイン名で表記されるため、同一ドメインという呼び方がなされます。

ホストに加えて、さらにポートも同一の場合、すなわちホスト、ポートの両方が同一である場合、それらを「同一サイト」(same site)であると言います。さらにスキームも同一の場合、すなわちスキーム、ホスト、ポートの全てが同一である場合、それらを「同一オリジン」(same origin)であると言います。

ウェブのセキュリティモデルは、原則としてオリジンの考え方にもとづきます。この考え方を「同一オリジンポリシー」(same-origin policy)と言い、オリジンが同一でないリソースの扱いに制限を課すことがあります。同一オリジンポリシーの詳細は、MDNを参照するとよいでしょう[^10]。

[^10]: <https://developer.mozilla.org/ja/docs/Web/Security/Same-origin_policy>

ただし、歴史的な理由で、オリジンではなくサイトの考え方を採用しているケースもあります。その典型例は「クッキー」(Cookie)です。同一サイトであればスキームが異なってもクッキーを送信するため、`https`スキームでクッキーを利用する場合は、クッキー側でsecure属性を指定するといった配慮が必要になります。

## クロスオリジンアクセス

あるリソースが、現在のリソースと異なるオリジンであるとき、これを「クロスオリジン」(cross origin)と言います[^11]。クロスオリジンのリソースにアクセスすることを「クロスオリジンアクセス」と言います。

[^11]同様に、ドメインが異なるもの、サイトが異なるものをそれぞれ「クロスドメイン」「クロスサイト」と言います。ただし、ドメイン、サイト、オリジンを厳密に区別せずに、同じ意味で使われることもあります。

たとえば、ウェブフォントやJavaScriptのライブラリを外部のサービスから読み込むような場合、これはクロスオリジンでアクセスしていると言えます。

<!-- 外部のドメインからWebフォントやJavaScriptを読み込む例 -->
```html
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?xxxx">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xxx.js"></script>
```

単純にHTMLの表示にクロスオリジンのリソースを利用する場合、通常はクロスオリジンでの参照が可能です。上記のような例も問題なく動作します。

ただし、HTML側のJavaScriptからは、クロスオリジンで取得したサブリソースの内容を読み取ることができないようになっています。これは、たとえ悪意あるコンテンツを表示しても、他のオリジンのリソースを読み取られないようにするためです。

クロスオリジンで取得したリソースを読み取る必要がある場合は、CORS (Cross-Origin Resource Sharing)と呼ばれる仕組みを利用することができます。CORSの詳しい説明はMDNを参照してください[^11]。

[^11]: <https://developer.mozilla.org/ja/docs/Web/HTTP/CORS>

## コラム: URLという言葉の歴史

URLという言葉は多くの読者に馴染みがあると思いますが、この言葉は混乱を乗り越えてきた歴史があります。

バーナーズ＝リーが最初に提唱したURLは、"Universal Resource Locator"の略称でした。後に、"Uniform Resource Locator"の略称とされ、最初期にはRFC 1630、次にRFC 1738として標準化されました。

その後、リソースを場所ではなく名前で特定する「URN」(Uniform Resource Name)という方式が提唱され、RFC 2141で規定されます。そして、URLとURNをあわせたものを「URI」(Uniform Resource Identifier)と呼ぶようになりました。URIは初めにRFC 2396、後にRFC 3986として標準化されました。古いHTML4の仕様では“URI”という表記が使われています。

その後、URIの国際化表記である「IRI」(Internationalized Resource Identifier)がRFC 3987として標準化されます。こうして、“URL”、“URI”、“IRI”という3種類の表記が生まれました。“URL”は“URI”の一種であり、“URI”は“IRI”の一種です。“URL”という言葉が使える文脈では、3つのどれを使っても意味が通じます。

様々な技術仕様で、技術用語としてURIやIRIが用いられました。しかし、各技術仕様で規定しているURIやIRIがそれぞれ微妙に異なり、技術的な内容としても混乱していました。その一方、世間一般では“URI”や“IRI”はそこまで知られておらず、“URL”という言葉が使われ続けていたのです。

そこでWHATWGは、URL、URI、IRIの概念を統合・整理し、あらためて再度“URL”と名付けることにしました。名前がURL→URI→IRIと変遷した上で、もう一度“URL”に戻ってきたということになります。このURLは、もはや"Uniform Resource Locator"の略ではありません。現在のWHATWG URLは、何かの略ではなく、単にURLという名前のものであるとされています。
