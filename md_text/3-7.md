<!-- ch3-7.txt (4ページ、3000～4600字想定) -->
# エンベティッドコンテンツ

Webページには、画像や音声、映像などのメディアを埋め込むことができます。また、Webページの一部に他のWebページを埋め込むこともできます。この節では、こういったメディアの埋め込みを行う要素について説明します。

## `img`要素

`img`要素は、画像を表す要素です。PNG、GIF（アニメーションGIFを含む）、JPEG、SVGといった画像をHTMLに埋め込むことができます。`src`属性で画像のURLを指定します。

```html
<img src="cat.png" alt="ねこのかわいい写真">
```

`alt`属性の値は、画像を処理できないか、読み込みが無効な場合に、等価なコンテンツを提供する、原則として必須の属性です。適切な値については、`alt`属性の節で検討します。

`srcset`属性で、画像候補を指定できます。詳細については、レスポンシブ画像の節で説明します。

[^1]: いくつかのバリエーションがありますが、ブラウザーで扱うものについては、Infra Standardで定義されています。

### `src`属性とデータURL

`src`属性には画像データのあるURLを指定しますが、データURL[^1]を指定することで、画像を直接埋め込むこともできます。データURLとは、`data:`スキームで始まるURLで、URLの中にデータを直接表現するものです。現在はfetch Standardで定義されています。以下はデータURLでSVG画像を埋め込んだ例です。

```html
<img src="data:image/svg+xml,%3csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20version=%221.1%22%20viewBox=%220%200%20100%20100%22%3e%3crect%20fill=%22%23ff3300%22%20width=%22100%22%20height=%22100%22%20rx=%2220%22%20ry=%2220%22/%3e%3c/svg%3e" alt="">
```

データURLには、Base64エンコードを行ってバイナリデータを埋め込むことも可能です。

```html
<img src="data:image/png,base64,(バイナリデータをbase64エンコードしたもの)" alt="">
```

一部のブラウザ<!--(IEなど)-->は先の例のようなテキスト埋め込み形式のデータURLに対応していない場合があるため、互換性のためにSVGもあえてbase64エンコードして埋め込む場合があります。

[^1]: 現在では fetch standard で定義されています。 <https://fetch.spec.whatwg.org/>


### `alt`属性の役割と原則

`alt`属性は、画像の代替テキスト（alternative text）または置換テキスト（replacement text）を表します。

何らかの原因で画像が見られない場合、画像の代わりに代替テキストによって内容が伝えられます。スクリーンリーダーの利用者がアクセスした場合はもちろん、検索エンジンなどの機械がアクセスする場合、ネットワークが不調で画像が表示できない場合、環境等によりユーザーの視覚が十全に機能しない場合など、さまざまな場合に代替テキストが活用されます。ウェブアクセシビリティを考える上で、もっとも重要な属性の1つに挙げられます。

例外を除いて、`alt`属性は省略してはいけません。また、装飾的な画像のような場合を除いて、等価な代替テキストを属性値に記述しなければなりません。

どのような場合に属性値を空にするのか(`alt=""`)、どのような代替テキストが望ましいか、属性そのものを省略するのはどのような場合かについての例は、WHATWGおよびW3CのHTML仕様のRequirements for providing text to act as an alternative for images[^3] [^4]でそれぞれ詳しく説明されています。また、アクセシビリティの観点からAn alt Decision Tree[^5]というW3Cによるリソースも存在します。それぞれ参考にするとよいでしょう。

[^3]: https://html.spec.whatwg.org/multipage/images.html#alt
[^4]: https://www.w3.org/TR/html/semantics-embedded-content.html#alt-text
[^5]: https://www.w3.org/WAI/tutorials/images/decision-tree/

`alt`属性の値として何らかの代替テキストを置くことができる場合に、その書き方については絶対的な正解というものは存在しません。画像を通してウェブページで言いたいことは、そのページのコンテキストに依存します。どのような意図でその画像が埋め込まれるのか、制作の意図をしっかりと把握した上で、代替テキストを記述することが求められます。

ここでは、代替テキストを記述するにあたって考慮すべき2つの原則を紹介しておきます。

#### 代替テキストの第一原則: 画像と等価なテキストであること
1つ目の原則は、画像と等価なテキストであることです。代替テキストは、画像の内容を過不足なく伝えるものであるべきです。言い換えるなら、画像をテキストに置き換えても、コンテンツの意味が変わらないようにするということです。

代替テキストを考える方法としてよくあるのは、電話で誰かに伝える状況を想像することです。電話口でコンテンツを読み上げていき、画像に差し掛かった時にどう言うか、それを考えて代替テキストにするとよいでしょう。ただし、必要以上に詳しく説明したり、意味を補ったりしないように注意してください。

代替テキストの内容は、画像の性質によってある程度決定されますが、時には、同じ画像に異なる代替テキストが指定されることもあり得ます。全く同じ画像でも、文脈によって伝わるべき内容が変化することがあるからです。

<!--地図の例。
イメージとしては、 https://www.ginza-vd.com/wp-content/themes/vd/img/imgMap.gif このような画像でより抽象化した架空の地図を用意する -->

```html
<p>
<img src="rough-map.png" alt="当社入居ビルまでの地図。九段下駅の6番出口から出て、靖国通りを西に進み、九段下の交差点を南に進んだ建物です。">
```

例えば、最寄りの駅から会社のビルまでの簡単な経路を示した略図をマークアップするならば、上記のように代替テキストを付与することが考えられるでしょう。仮に、略図には示していないコンビニエンスストアが、ビルのすぐ隣にあったとしても、そのことは代替テキストに含めないのが普通です。ここでの略図は会社への経路を伝えることを目的としており、情報を付け足してまうと、等価な代替テキストにはなりません。

しかし時には、同じ地図の画像でコンビニエンスストアの場所を伝えたい場合もあるかもしれません。そのような場合は当然、コンビニエンスストアについて言及することになるでしょう。このように、同じ画像でも、文脈によって代替テキストが異なる場合があります。

#### 代替テキストの第二原則: 繰り返しを避ける
もう1つの原則は、繰り返しを避けることです。画像の前後にキャプションや説明文が提供されることがしばしばありますが、その情報を繰り返すべきではありません。以下の例は、先の例と同じ地図を想定していますが、ここでは地図の下に道順の説明文がついています。

<!-- 地図の例2 -->
```
<p><img src="rough-map.png" alt="当社ビルまでの地図">
<p>当社入居ビルまでの地図。九段下駅の6番出口から出て、靖国通りを西に進み、九段下の交差点を南に進んだ建物です。</p>
```

地の文で道順を示しているため、`alt`には道順を記載せず、単にどのような画像かを記しています。冗長な情報を省くことで、スクリーンリーダーが同じ内容を二度読み上げることを防ぎます。

なお、`alt=""`を指定した場合には、画像の存在自体が伝わらなくなることに注意してください。上記の例では、`alt`属性の内容と続く文の冒頭が重複していますが、これを全て省いて`alt=""`を指定した場合、スクリーンリーダーの利用者には画像の存在自体が伝わりにくくなりますし、画像を保存するといった操作も難しくなってしまいます。意味のある画像に対しては、多少重複しても何かしらの代替テキストを指定しておく方が良いでしょう。

<!-- a11y note -->
`img`要素のデフォルトARIAロールは、`alt`属性の値によって変化します。

空でない`alt`属性が指定されている場合は`img`ロールとなり、画像がある扱いになります。多くのスクリーンリーダーは、代替テキストを読み上げたあとに「イメージ」「画像」などと読み上げ、そこに画像があることを伝えます。

空の`alt`属性、すなわち`alt=""`が指定されている場合は`presentation`ロール、すなわち特定の役割を持たない状態になります。スクリーンリーダーはこれを無視し、何も読みません。画像があるということ自体が伝えらないことに注意してください。装飾画像やスペーサーなど、読まれない方が望ましいものに対して`alt=""`を指定すると良いでしょう。

`alt`属性そのものが省略されている場合、意味のある画像が置かれていて、しかしながら代替テキストが提供されていないものと解釈されます。この場合、スクリーンリーダーは画像の内容を可能な限り伝えようとします。`title`属性やその他の属性で読めるテキストが指定されていればそれを読みますが、そうでない場合、多くのスクリーンリーダーは画像のファイル名を読もうとします。ファイル名が意味ある単語ならば役に立つこともありますが、システムが生成した無意味な英数字の羅列がファイル名に使われている場合、それがそのまま読まれることになります。

```html
<img src="/assets/93cc401e5a2939b25985d1db70de2aa9.jpg">
```

この例は、「きゅうさんシーシー...(略)...エーきゅう、ジェイピージー、イメージ」などと読まれます。突然、意味不明な読み上げがはじまることになり、利用者は混乱することでしょう。`alt`属性を省略することは避けるべきです。
<!-- /a11y note -->

## `picture`要素とレスポンシブ画像

`picture`要素や`srcset`属性、`sizes`属性を使用すると、状況による画像の出しわけ、いわゆる「レスポンシブ」な画像を実現することができます。コンテンツ製作者は複数の画像リソースを提示し、ユーザーエージェントがその中から最適な画像を選択します。選択の基準には以下の4つがあります。

- デバイスピクセル比に基づく選択(Device-pixel-ratio-based selection)
- ビューポートに基づく選択(Viewport-based selection)
- アートディレクションに基づく選択(Art direction-based selection)
- 画像フォーマットに基づく選択(Image format-based selection)

最初の2つは`img`要素の`srcset`や`sizes`属性を用いて、後の2つは`picture`と`source`要素を用いて実現します。以下、各選択基準について簡単に説明します。

### デバイスピクセル比に基づく選択
画像のレンダリングサイズを固定した上で、デバイスピクセルの異なる複数の画像を提示して、そのデバイスに適した解像度の画像を選択します。より高精細な画面で高解像度の画像を表示させたい場合などに利用できます。

<!-- HTML LS -->
```html
<img src="/uploads/100-marie-lloyd.jpg"
     srcset="/uploads/150-marie-lloyd.jpg 1.5x, /uploads/200-marie-lloyd.jpg 2x"
     alt="" width="100" height="150">
```

`srcset`属性で複数の画像を指定し、それぞれに`x`記述子でデバイスのピクセル比を記述します。これにより、高いデバイスピクセル比を持つスクリーンで、より高解像度となる画像が選択されます。

### ビューポートに基づく選択の例
画像のレンダリングサイズを固定せずに、デバイスピクセルの異なる複数の画像を提示して、ビューポートの大きさに適したサイズの画像を選択します。ウィンドウの一定割合を画像で表示させたい場合など利用できます。

<!-- HTML LSからのコピー -->
```html
<img sizes="100vw" srcset="wolf-400.jpg 400w, wolf-800.jpg 800w, wolf-1600.jpg 1600w"
     src="wolf-400.jpg" alt="The rad wolf">
```

`srcset`属性で複数の画像を指定し、それぞれに`w`記述子で画像のサイズを記述します。`sizes`属性で指定されるレンダリングサイズから各画像の効果的なピクセル密度を算出し、画面のピクセル密度、ズームレベル、ネットワークの状態などから、最適な画像をユーザーエージェントが選択します。

上記のコード例では、たとえばビューポートの幅が320 CSSピクセルである場合 (100vw=320pxとなる場合)、`wolf-400.jpg 1.25x, wolf-800.jpg 2.5x, wolf-1600.jpg 5x`という指定と等価になります。

なお、上記のコード例では`src`属性と`srcset`属性の両方で"wolf-400.jpg"を指定していますが、これは互換性のための指定です。`srcset`属性の`w`記述子を理解するユーザーエージェントは`src`属性を無視します。

### アートディレクションに基づく選択
複数の画像を提示し、それぞれに対してメディアクエリを指定すると、指定した状況に応じて画像を切り替えることができます。縦長の画面と横長の画面で表示する画像を切り替えたい場合など、コンテンツ製作者側で細かい制御をしたい場合に利用できます。

<!-- https://dev.opera.com/articles/ja/responsive-images/ 改 -->
```html
<picture>
  <source media="(min-width: 1024px)"
                srcset="fullshot.jpg">
  <img src="closeup.jpg" alt="Opera House">
</picture>
```

ブラウザーのウィンドウ幅が1024 CSSピクセル以上の場合、全景の写真（fullshot.jpg）が選択されます。ウインドウ幅がそれよりも小さい場合は、ズームアップされた写真（closeup.jpg）が選択されます。

### 画像フォーマットに基づく選択の例
Webで使用できる画像のフォーマットには様々なものがありますが、ユーザーエージェントがその全てに対応しているとは限りません。モダンなユーザーエージェントには新しいフォーマットの画像を表示させつつ、対応していないユーザーエージェントには広くサポートされている古い画像フォーマットを選択させたいような場合に、この機能を利用できます。

```html
<picture>
 <source srcset="happy.webp" type="image/webp">
 <source srcset="happy.jxr" type="image/vnd.ms-photo">
 <img src="happy.jpg" alt="">
</picture>
```

この例ではブラウザーがWebPをサポートする場合はWebPを、そうでなければJPEG XR画像を、いずれもサポートしない場合はフォールバックとしてJPEGが選択されます。

<!--
参考リソース
https://www.html5rocks.com/ja/tutorials/responsive/picture-element/
https://dev.opera.com/articles/ja/responsive-images/
https://developer.mozilla.org/ja/docs/Web/HTML/Element/picture
https://developer.mozilla.org/ja/docs/Web/HTML/Element/source
-->

<!-- 画像だけ、というわけでもない -->
## `iframe`要素

`iframe`（インラインフレーム）要素は、現在表示しているページに別のウェブコンテンツを埋め込む要素です。他のドメインのコンテンツでも埋め込めるため、サードパーティのドメインから配信される動画やスライド、広告といったものを埋め込むのによく利用されています。

その性質上、他のウェブ上のサービスから指定されたコードを貼り付けることが多いと思いますが、提供されるHTMLコードが文法上必ずしも正しいとは限りませんし、アクセシビリティの配慮が不足していることもあるため注意が必要です。たとえば、以下は2019年10月に確認したYouTubeの埋め込みコードです。

```html
<iframe width="560" height="315" src="https://www.youtube.com/embed/PyJOEt2nsGQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
```

`frameborder`属性は廃止されていますし、ウェブアクセシビリティの観点から、`title`属性でラベル付けすることが望まれるでしょう。

`src`属性はリソースの存在するURLを指定します。上記の例では、YouTubeの埋め込みプレーヤーのURLを指定しています。

`allow`属性はPermissions policy仕様[^6]に基づいて、許可する機能やAPIを指定するものです。`allowfullscreen`属性についてもPermissions policy仕様に基づくものであり、全画面表示のAPI `requestFullscreen()`を許可する真偽属性です。

[^6]: Permissions Policy https://w3c.github.io/webappsec-permissions-policy/

また、`srcdoc`属性でHTMLを直接埋め込むことも可能です。

```html
<iframe sandbox srcdoc="<p>ごはんを温めますか？"></iframe>
```

<!-- 内容モデル -->
`iframe`要素の内容モデルは"Nothing"です。つまり、内容に何も入れることができません。にもかかわらず、`iframe`要素は空要素ではありません。つまり、`iframe`要素の終了タグは省略できません。

歴史的には、`iframe`要素を解釈しないブラウザに対して、`iframe`要素の内容をフォールバックとして認識させる書き方がありました。

```html
<!-- 現在では正しくない書き方 -->
<iframe src="xxx.html">iframeを知らないブラウザに表示させたい内容</iframe>
```

現在ではこのような書き方は許されておらず、この例は単に文法違反になります。ブラウザは`iframe`要素の内容を無視し、表示しません。
<!-- /内容モデル -->

<!-- a11y note -->
`iframe`はアクセシビリティ上の問題を起こしやすい要素です。スクリーンリーダーでは`iframe`の内容をそのまま読む場合、能動的に操作をしないと中身を読まない場合など、種類や設定によって扱われ方が異なります。
`iframe`要素に`title`属性をつけておくと、スクリーンリーダーはその内容を読んでくれることがあります。`iframe`を広告と考えて読み飛ばす利用者もいるため、有用な`iframe`にはきちんと名前をつけておくと良いでしょう。
<!-- /a11y note -->

<!-- security consideration -->
`iframe`要素にはセキュリティ上の問題も多く知られており、使い方を誤ると攻撃に悪用されることがあります。また、`iframe`要素を悪用した攻撃もあります。その代表例が「クリックジャッキング」と呼ばれる手法で、この対策として多くのサイトが`iframe`で読み込まれないように制限を行っています。そのため、`iframe`要素で埋め込もうとしても、埋め込むことができない場合があります。

また、`iframe`で読み込んだウェブページと、`iframe`の置かれたウェプページは、`postMessage`という機能で通信し、情報のやり取りをすることができます。この利用法を誤ると、情報漏洩などのセキュリティ問題を起こすことがあります。本書では詳細を述べませんが、セキュリティに配慮して利用すると良いでしょう。[^1]

[^1]: 徳丸浩著「体系的に学ぶ 安全なWebアプリケーションの作り方 第2版 脆弱性が生まれる原理と対策の実践」などが参考になります。
<!--
https://blog.jxck.io/entries/2018-03-08/feature-policy-permission-delegation.html
-->
`iframe`要素に`sandbox`属性を指定すると、JavaScriptやフォームの実行等に対して制限を加えることができます。空文字列として使用することで、最大限の制限を行います。定められたトークンを（複数の場合はスペース区切りで）属性値に指定することで、個別の制限を許可します。<!-- トークンを列挙する必要は…？ -->
<!-- https://www.jpcert.or.jp/research/HTML5-20131030.pdf -->
<!-- /security consideration -->

## `embed`要素
`embed`要素は外部のアプリケーションやインタラクティブなコンテンツを埋め込むために使用するものです。過去には、Flashで実装されたコンテンツを埋め込むために使われることがありました。次のコードはFlashプラグインを用いるFlashの動画を埋め込む古典的な例です。

```html
<embed src="movie.swf">
```

<!-- 内容モデル -->
embed要素の内容モデルは"Nothing"です。空要素であり、終了タグを書くこともありません。
<!-- /内容モデル -->

## `object`要素と`param`要素

`object`要素は、外部リソースを表す汎用的な要素です。主にプラグインで処理されるコンテンツなどを埋めこむことができます。画像や映像、音声、HTML文書の埋め込みにも利用できますが、`img`、`iframe`、`video`、`audio`といった専門の要素で代用が可能なことが多いでしょう。

子要素に`param`要素を持つことができます。これにより、`object`要素にパラメーターを与えることができます。

次のコードはFlashプラグインを用いるFlashの動画を埋め込む古典的な例です。

```html
<!-- oblect要素のみで指定 -->
<object data="movie.swf"
  type="application/x-shockwave-flash"></object>

<!-- param要素と併用で指定 -->
<object type="application/x-shockwave-flash">
  <param name=movie value="movie.swf">
</object>
```

<!-- 内容モデル -->
`object`要素の内容モデルは`param`要素と、それに続いて"Transparent"の内容を書くことができます。"Transparent"の部分はフォールバックコンテンツとなります。指定したリソースが埋め込み表示できない場合、その代わりに`object`要素の内容が使われるのです。これは画像でいう代替テキストのような機能を果たします。`img`要素の`alt`属性と異なり、マークアップを含むことができるため、メディアへの直接リンクを提供したり、テキストの一部を強調したりできます。

```html
<object data="rough-map.png">
<!--画像が埋め込み表示できない場合、以下が表示される-->
<p><a href="rough-map.png">当社入居ビルまでの地図</a>。
九段下駅の<em>6番出口</em>から出て、靖国通りを西に進み、九段下の交差点を南に進んだ建物です。</p>
</object>
```

`object`要素の中に`object`要素を入れ子にすることも可能です。この場合、親から順に表示を試みて、表示できない場合には子に随時フォールバックしていきます。

```html
<!-- できればsvgを表示したい -->
<object data="image.webp">
  <!-- svgがだめならwebpを表示 -->
  <object data="image.webp">
    <!-- webpもだめならpngを表示 -->
    <object data="image.png">
      <!-- 画像が何も表示できないなら代替テキストを使用 -->
      <p>代替テキストです</p>
    </object>
  </object>
</object>
```
<!-- /内容モデル -->

<!-- a11y note -->
`object`要素にデフォルトのロールはありません。`object`要素はさまざまなリソースを扱えるため、リソースに応じたロールをつけておくことが望ましいでしょう。画像を読み込んでいるなら`role="img"`、HTMLなどの文書を読みんでいるなら`role="document"`を指定するとよいでしょう。`object`要素の内容がアプリケーションのようなもので、キー操作を必要とする場合は、`role="application"`を指定することで、キー操作を直接 (スクリーンリーダーに横取りされずに) 渡すことができる場合があります。
<!-- /a11y note -->


## メディア要素

仕様では`video`要素および`audio`要素をまとめてメディア要素と呼びます。前者は映像を表し、後者は音声を表します。どちらの要素も、`source`要素を用いて複数の異なるフォーマットのリソースを指定できます。

``` video要素の例
<video controls src="https://archive.org/download/BigBuckBunny_124/Content/big_buck_bunny_720p_surround.mp4"
    poster="https://peach.blender.org/wp-content/uploads/title_anouncement.jpg?x11217"
    width="620">

このブラウザーは埋め込み動画に対応していません。
しかし、<a href="https://archive.org/details/BigBuckBunny_124">ダウンロード</a>
して好みの動画プレイヤーで見ることはできます。
</video>
```

```audio要素の例
<audio>
 <source src="foo.ogg" type="audio/ogg; codecs=vorbis"/>
 <source src="foo.mp3" type="audio/mpeg"/>
</audio>
```

### WebVTT

音声は聴覚に障害がある人にとって、映像は視覚に障害がある人にとって、ウェブアクセシビリティ上の懸念が存在します。この問題に対処する1つの方法として、WebVTT (Web Video Text Tracks)フォーマットと呼ばれる、時間指定のテキストトラック（字幕やキャプションなど）を表示するためのデータフォーマットを利用できます。

``` WebVTTの記述例（コードグリッドからのほぼ複写 （CC-BY 3.0）https://app.codegrid.net/entry/2017-webvtt-1）
WEBVTT

NOTE
これはコメントです。

my-cue-id-1
00:00.000 --> 00:05.000 line:90%
これは<b>WebVTT</b>による字幕です。
```
```こちらも複写
 <video>
    <!-- 読み込む動画ファイルの指定 -->
    <source src="movie.mp4" type="video/mp4">
    <!-- 読み込む字幕ファイルの指定（日本語） -->
    <track label="日本語" kind="captions" srclang="ja" src="movie-ja.vtt" type="text/vtt" default>
    <!-- 読み込む字幕ファイルの指定（英語） -->
    <track label="English" kind="captions" srclang="en" src="movie-en.vtt" type="text/vtt">
  </video>
```
このように指定することで、映像に字幕を付与できます。これにより、ウェブアクセシビリティを確保することができます。

## イメージマップ
イメージマップは、1つの画像上で、クリックする場所によって別々のリンクを割り当てることのできる機能です。`img`要素、`map`要素および`area`要素によって実現します。

```LSからのコピー（改）
<p>
 形状を選んでください:
 <img src="shapes.png" usemap="#shapes"
      alt="くり抜かれた赤い正方形、緑の円、青い三角形、十字型の黄色の星の4つの形状があります。">
 <map name="shapes">
  <area shape=rect coords="50,50,100,100"> <!-- 赤い正方形の穴 -->
  <area shape=rect coords="25,25,125,125" href="red.html" alt="赤い正方形">
  <area shape=circle coords="200,75,50" href="green.html" alt="緑の円">
  <area shape=poly coords="325,25,262,125,388,125" href="blue.html" alt="青い三角形">
  <area shape=poly coords="450,25,435,60,400,75,435,90,450,125,465,90,500,75,465,60"
        href="yellow.html" alt="黄色の星">
 </map>
</p>
```

`img`要素の`usemap`属性と、`map`要素の`name`属性とでイメージマップを関連付けます。`name`はイメージマップの名前になります。`usemap`属性値はハッシュ名による`name`への参照です。

`area`要素の`shape`属性は、イメージマップ内に作成する図形の種類を表し、`circle`、`poly`、`rect`、`default`の4つのキーワードから選択する列挙属性です。

`coords`属性は、イメージマップ内に作成する図形の座標を表す、CSS ピクセルで表されるリストです。指定する座標の数は、`shape`属性値によって変化します。

